<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GPT Chat ‚Äî Tek Dosya (Saƒülam)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f172a; --line:#1e293b; --text:#e6eef6; --muted:#93a4b8;
    --acc:#22d3ee; --acc2:#34d399;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--text);
    background:
      radial-gradient(1000px 700px at -10% -10%, rgba(34,211,238,.18), transparent 60%),
      radial-gradient(1000px 700px at 110% 110%, rgba(52,211,153,.16), transparent 60%),
      linear-gradient(180deg, #0a0f15, #0b1118);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  }
  .app{max-width:980px;margin:0 auto;padding:18px}
  .card{background:rgba(15,23,42,.72);backdrop-filter:blur(8px);border:1px solid var(--line);
        border-radius:20px;box-shadow:0 30px 80px rgba(0,0,0,.45);overflow:hidden}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;
         padding:14px 16px;border-bottom:1px solid var(--line)}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:9px;background:conic-gradient(from 120deg,#0ea5e9,#22c55e)}
  h1{font-size:15px;margin:0;letter-spacing:.3px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select, input[type=text]{background:#0b1320;color:var(--text);border:1px solid #243247;border-radius:10px;padding:8px 10px;height:38px;outline:none}
  .btn{height:38px;border:1px solid #234;color:#052f2b;background:linear-gradient(180deg,#27e0cc,#1bc2b5);
       border-radius:12px;padding:0 12px;font-weight:700;cursor:pointer}
  .btn.sec{background:#0b1320;color:var(--text);border-color:#243247;font-weight:600}
  .btn.warn{background:#ef4444;border-color:#ef4444;color:#fff}
  #chat{height:60vh;overflow:auto;padding:12px}
  .msg{display:flex;gap:10px;margin:10px 0;align-items:flex-start}
  .b{flex:0 0 38px;height:38px;border-radius:10px;display:grid;place-items:center;background:#0b1320;border:1px solid #213047}
  .user .b{background:#18212f}.bot .b{background:#0b3b32;border-color:#0b3b32}
  .bubble{padding:10px 12px;border-radius:14px;max-width:78%;border:1px solid #1f2a3d;background:#0e1520}
  .user .bubble{background:#141c2a}.bot .bubble{background:#0a2e27;border-color:#0a3a33}
  .actions{margin-top:6px;display:flex;gap:6px}
  .action{font-size:12px;padding:4px 8px;border-radius:8px;border:1px solid #264;background:#0d1b1a;color:#a7f3d0;cursor:pointer}
  form{display:flex;gap:10px;padding:12px;border-top:1px solid var(--line);background:#0e1520}
  textarea{flex:1;min-height:44px;max-height:180px;resize:none;padding:12px;border-radius:14px;background:#0b1320;color:var(--text);border:1px solid #243247;outline:none}
  .send{min-width:120px}
  .muted{color:var(--muted)}
  .spin{display:inline-block;width:16px;height:16px;border:2px solid #a7f3d0;border-right-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  /* Modal */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(3,6,10,.66)}
  .modal.show{display:grid}
  .box{width:min(560px,92%);background:#0e1623;border:1px solid #203049;border-radius:16px;padding:16px}
  .box h2{margin:0 0 10px 0;font-size:18px}
  .row{display:flex;gap:10px;align-items:center;margin:10px 0}
  .row input[type=password]{flex:1;background:#0b1320;color:var(--text);border:1px solid #243247;border-radius:10px;padding:10px}
  .hint{font-size:13px;color:var(--muted)}
  .kbd{border:1px solid #2a3b55;background:#0b1320;color:#c3d5ea;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <header>
      <div class="brand"><div class="logo"></div><h1>GPT Chat</h1></div>
      <div class="controls">
        <select id="model">
          <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
          <option value="gpt-4o">gpt-4o</option>
          <option value="gpt-4.1-mini">gpt-4.1-mini</option>
        </select>
        <input id="system" type="text" placeholder="System: (√∂rn. T√ºrk√ße ve kƒ±sa cevap ver)">
        <button class="btn sec" id="clear">Temizle</button>
        <button class="btn sec" id="keyBtn">API Anahtarƒ±</button>
      </div>
    </header>

    <div id="chat" aria-live="polite"></div>

    <form id="form">
      <textarea id="input" placeholder="Mesajƒ±nƒ± yaz... (Enter = G√∂nder, Shift+Enter = Satƒ±r)" required></textarea>
      <button class="btn send" id="send" type="submit">G√∂nder</button>
    </form>
  </div>
  <p class="muted" style="margin:10px 6px 0">Not: Anahtar yerelde saklanƒ±r. √úretim i√ßin backend kullan.</p>
  <pre id="log" class="muted" style="white-space:pre-wrap;font-size:12px;max-height:24vh;overflow:auto;margin-top:8px"></pre>
</div>

<!-- API KEY MODAL -->
<div class="modal" id="modal">
  <div class="box">
    <h2>OpenAI API Anahtarƒ±</h2>
    <div class="hint">Panelden aldƒ±ƒüƒ±n anahtarƒ± buraya yapƒ±≈ütƒ±r. Payla≈üma.</div>
    <div class="row">
      <input id="key" type="password" placeholder="√∂r. sk-proj-................">
      <button class="btn" id="saveKey">Kaydet</button>
      <button class="btn sec" id="cancelKey">Kapat</button>
    </div>
    <div class="hint">Kƒ±sayol: <span class="kbd">Ctrl/Cmd</span> + <span class="kbd">Enter</span></div>
  </div>
</div>

<script>
/* ===== yardƒ±mcƒ±lar ===== */
const $ = (id)=>document.getElementById(id);
const chat=$("chat"), form=$("form"), input=$("input"), sendBtn=$("send");
const modelSel=$("model"), systemInput=$("system");
const keyBtn=$("keyBtn"), clearBtn=$("clear");
const modal=$("modal"), keyInput=$("key"), saveKeyBtn=$("saveKey"), cancelKeyBtn=$("cancelKey");
const logEl=$("log");
const LS_KEY="openai_api_key";
const state={ messages:[] };

function log(txt){ logEl.textContent = (txt ? String(txt) : "") + "\n" + logEl.textContent.slice(0,4000); }
function esc(s){ return s.replace(/[&<>]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }
function mdLite(t){ return esc(t).replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>").replace(/\n/g,"<br>"); }
function addMsg(role, html, plain=""){ const row=document.createElement("div"); row.className="msg "+(role==="user"?"user":"bot");
  row.innerHTML=`<div class="b">${role==="user"?"üë§":"ü§ñ"}</div><div class="bubble">${html}</div>`;
  if(role==="assistant"){ const acts=document.createElement("div"); acts.className="actions";
    const c=document.createElement("button"); c.className="action"; c.type="button"; c.textContent="Kopyala"; c.onclick=()=>navigator.clipboard.writeText(plain);
    acts.appendChild(c); row.lastElementChild.appendChild(acts);
  }
  chat.appendChild(row); chat.scrollTop=chat.scrollHeight; return row;
}
let typingEl=null; function showTyping(){ typingEl=addMsg("assistant",`<span class="spin"></span> Yazƒ±yor...`);} function hideTyping(){ if(typingEl){typingEl.remove(); typingEl=null;} }

function cleanKey(k){ return (k||"").replace(/[^\x20-\x7E]/g,"").replace(/\s+/g,"").replace(/\.$/,""); }
function getKey(){ return cleanKey(localStorage.getItem(LS_KEY)||""); }
function setKey(k){ const c=cleanKey(k); localStorage.setItem(LS_KEY,c); return c; }
function openModal(){ modal.classList.add("show"); keyInput.value=getKey(); keyInput.focus(); }
function closeModal(){ modal.classList.remove("show"); }
if(!getKey()) openModal();
keyBtn.onclick=openModal; cancelKeyBtn.onclick=closeModal;
saveKeyBtn.onclick=()=>{ const saved=setKey(keyInput.value); if(!saved.startsWith("sk-")) alert("Anahtar sk- ile ba≈ülamƒ±yor olabilir. Yine de kaydedildi."); closeModal(); };
keyInput.addEventListener("keydown",e=>{ if((e.key==="Enter")&&(e.metaKey||e.ctrlKey)) saveKeyBtn.click(); });

clearBtn.onclick=()=>{ state.messages=[]; chat.innerHTML=""; addMsg("assistant","Sohbet temizlendi. Hazƒ±rƒ±m! ‚ú®"); };
addMsg("assistant","Merhaba! Mesaj yaz, ben de cevaplayayƒ±m. Saƒü √ºstten model ve system y√∂nergesi girebilirsin.");

/* === asƒ±l kƒ±sƒ±m === */
// Mesaj ge√ßmi≈üini tek metne d√∂n√º≈üt√ºr (Responses API i√ßin g√ºvenli)
function buildPrompt(msgs){
  return msgs.map(m=>{
    const r = m.role.toUpperCase();
    return `${r}: ${m.content}`;
  }).join("\n\n");
}

input.addEventListener("keydown",e=>{ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); form.requestSubmit(); } });
form.addEventListener("submit",async e=>{
  e.preventDefault();
  const text=input.value.trim(); if(!text) return; input.value="";
  addMsg("user", mdLite(text));
  if(state.messages.length===0 && systemInput.value.trim()){
    state.messages.push({role:"system", content:systemInput.value.trim()});
  }
  state.messages.push({role:"user", content:text});
  await query();
});

async function query(){
  const key=getKey();
  if(!key||!key.startsWith("sk-")){ addMsg("assistant","‚ö†Ô∏è API anahtarƒ±nƒ± ayarla: Saƒü √ºstte <strong>API Anahtarƒ±</strong> butonuna tƒ±kla.","Anahtar yok"); return; }
  const model=modelSel.value;
  showTyping(); sendBtn.disabled=true; input.disabled=true;

  try{
    // 1) Responses API (√∂nerilen)
    const body1 = {
      model,
      input: buildPrompt(state.messages),
      max_output_tokens: 400
    };
    const r1 = await fetch("https://api.openai.com/v1/responses", {
      method:"POST",
      headers:{ "Authorization":"Bearer "+key.trim(), "Content-Type":"application/json" },
      body: JSON.stringify(body1)
    });

    let ok=false, text="";
    if(r1.ok){
      const data=await r1.json().catch(()=>null);
      // √ñnce output_text, yoksa i√ßeriƒüe in
      text = (data && (data.output_text ||
              data?.output?.[0]?.content?.[0]?.text?.value ||
              data?.choices?.[0]?.message?.content || // bazƒ± varyantlar
              "")) || "";
      ok = !!text.trim();
      if(!ok){ log("Responses API bo≈ü geldi:\n"+JSON.stringify(data,null,2)); }
    }else{
      const errTxt = await r1.text().catch(()=> "");
      log("Responses hata "+r1.status+": "+errTxt);
    }

    // 2) Fallback: Chat Completions (eski ama yaygƒ±n)
    if(!ok){
      const msgs = state.messages.map(m=>({role:m.role, content:m.content}));
      const body2 = { model, messages: msgs, max_tokens: 400 };
      const r2 = await fetch("https://api.openai.com/v1/chat/completions", {
        method:"POST",
        headers:{ "Authorization":"Bearer "+key.trim(), "Content-Type":"application/json" },
        body: JSON.stringify(body2)
      });

      if(r2.ok){
        const d=await r2.json().catch(()=>null);
        text = d?.choices?.[0]?.message?.content || "";
        ok = !!text.trim();
        if(!ok) log("Chat Completions bo≈ü:\n"+JSON.stringify(d,null,2));
      }else{
        const err2 = await r2.text().catch(()=> "");
        log("ChatCompletions hata "+r2.status+": "+err2);
      }
    }

    hideTyping();
    if(ok){
      addMsg("assistant", mdLite(text), text);
      state.messages.push({role:"assistant", content:text});
    }else{
      addMsg("assistant","(bo≈ü yanƒ±t) ‚Äî Log kƒ±smƒ±na ham cevap yazƒ±ldƒ±, bakabilirsin.","(bo≈ü yanƒ±t)");
    }

  }catch(err){
    hideTyping();
    addMsg("assistant","‚ö†Ô∏è Aƒü/istemci hatasƒ±: "+(err.message||err), String(err));
    log(err && err.stack ? err.stack : String(err));
  }finally{
    sendBtn.disabled=false; input.disabled=false; input.focus();
  }
}
</script>
</body>
</html>
