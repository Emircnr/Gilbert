<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>XENAI ‚Äî Akƒ±llƒ± Sohbet</title>
<meta name="theme-color" content="#0b0f14">
<style>
  :root{
    --bg:#070b10; --panel:#0d1420; --panel2:#0b1220; --line:#162233;
    --text:#e6eef6; --muted:#99a9bd; --acc:#22d3ee; --acc2:#7c3aed;
    --chip:#0b1320; --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); background:
      radial-gradient(1200px 800px at -10% -10%, rgba(34,211,238,.15), transparent 60%),
      radial-gradient(1200px 800px at 110% 110%, rgba(124,58,237,.14), transparent 60%),
      linear-gradient(180deg, #090d13, #0a0f15);
    font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  }

  /* Layout */
  .shell{display:grid; grid-template-columns:300px 1fr; height:100%}
  @media (max-width: 980px){ .shell{ grid-template-columns:1fr } .sidebar{display:none} .header .left .brand h1{display:none} }

  .sidebar{
    border-right:1px solid var(--line); background:rgba(13,20,32,.7); backdrop-filter: blur(8px);
    display:flex; flex-direction:column; overflow:auto;
  }
  .header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 14px; border-bottom:1px solid var(--line);
    background: linear-gradient(180deg, rgba(34,211,238,.06), transparent);
  }
  .left{display:flex; align-items:center; gap:10px}
  .brand{display:flex; align-items:center; gap:10px}
  .logo{
    width:28px;height:28px;border-radius:10px;
    background: conic-gradient(from 120deg, var(--acc), var(--acc2));
    box-shadow: 0 0 24px rgba(34,211,238,.35), inset 0 0 14px rgba(0,0,0,.25);
  }
  .brand h1{font-size:15px;margin:0;letter-spacing:.25px}

  .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  select, input[type=text]{
    background:#0b1320; color:var(--text); border:1px solid #223249; border-radius:10px;
    height:36px; padding:6px 10px; outline:none;
  }
  .btn{
    height:36px; padding:0 12px; border-radius:10px; font-weight:700; cursor:pointer; border:1px solid #234;
    color:#071a1a; background:linear-gradient(180deg,#27e0cc,#1bc2b5);
  }
  .btn.ghost{background:#0b1320; color:var(--text); border-color:#243247}
  .btn.danger{background:#ef4444; color:#fff; border-color:#ef4444}
  .btn.pill{border-radius:999px}
  .badgelite{padding:4px 8px; border:1px solid #223047; border-radius:999px; background:#0b1320; color:var(--muted); font-size:12px}

  /* Sidebar */
  .sidehead{padding:10px 12px; border-bottom:1px solid var(--line); display:flex; gap:8px}
  .sidehead .btn{height:34px}
  .chats{flex:1; overflow:auto; padding:10px}
  .chatitem{
    border:1px solid #1a2a40; background:#0b1320; border-radius:12px; padding:10px; margin-bottom:10px; cursor:pointer;
  }
  .chatitem.active{outline:2px solid var(--acc); background:#0a1524}
  .chatitem .t{font-weight:700; font-size:14px; margin:0 0 4px 0}
  .chatitem .m{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  /* Main */
  .main{display:flex; flex-direction:column; height:100%}
  .toolbar{padding:10px; border-bottom:1px solid var(--line); display:flex; gap:8px; align-items:center; background:rgba(11,19,32,.6)}
  .toolbar .chip{background:#0b1320; border:1px solid #223047; border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted)}
  .toolbar .chip b{color:var(--text)}
  .tips{display:flex; flex-wrap:wrap; gap:6px; margin-left:auto}
  .tip{font-size:12px; border:1px dashed #2a3a55; padding:4px 8px; border-radius:999px; color:#b9c8dc}

  #chat{flex:1; overflow:auto; padding:14px}
  .msg{display:flex; gap:10px; margin:12px 0; align-items:flex-start}
  .b{flex:0 0 38px; height:38px; border-radius:10px; display:grid; place-items:center; background:#0b1320; border:1px solid #213047}
  .user .b{background:#192433} .bot .b{background:#0b3b32; border-color:#0b3b32}
  .bubble{padding:12px 14px; border-radius:14px; max-width:80%; border:1px solid #1f2a3d; background:#0e1520}
  .user .bubble{background:#131b2a} .bot .bubble{background:#0a2e27; border-color:#0a3a33}
  .meta{display:flex; gap:8px; align-items:center; color:#a2b5ca; font-size:12px; margin:6px 0 0 52px}
  .act{display:flex; gap:6px; margin-top:6px}
  .action{font-size:12px; padding:4px 8px; border-radius:8px; border:1px solid #264; background:#0d1b1a; color:#a7f3d0; cursor:pointer}

  /* Code & markdown */
  pre{background:#0b1320; border:1px solid #243247; padding:10px; border-radius:10px; overflow:auto}
  code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .bubble h1,.bubble h2,.bubble h3{margin:.4em 0}
  .bubble ul{margin:.3em 0 .3em 1.2em}
  a{color:#7dd3fc; text-decoration:none} a:hover{text-decoration:underline}

  /* Composer */
  .composer{display:flex; gap:10px; padding:12px; border-top:1px solid var(--line); background:#0e1520}
  textarea{
    flex:1; min-height:48px; max-height:220px; resize:none; padding:12px; border-radius:14px;
    background:#0b1320; color:var(--text); border:1px solid #243247; outline:none
  }
  .icbtn{height:44px; min-width:44px; display:grid; place-items:center; border-radius:12px; border:1px solid #243247; background:#0b1320; color:#cce3ff; cursor:pointer}
  .send{min-width:130px}

  .spin{display:inline-block;width:16px;height:16px;border:2px solid #a7f3d0;border-right-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Modal */
  .modal{position:fixed; inset:0; background:rgba(3,6,10,.66); display:none; place-items:center}
  .modal.show{display:grid}
  .box{width:min(560px,92%); background:#0e1623; border:1px solid #203049; border-radius:16px; padding:16px}
  .box h2{margin:0 0 10px 0; font-size:18px}
  .row{display:flex; gap:10px; align-items:center; margin:10px 0}
  .row input[type=password], .row input[type=text]{flex:1; background:#0b1320; color:var(--text); border:1px solid #243247; border-radius:10px; padding:10px}
  .hint{font-size:13px; color:var(--muted)}
  .kbd{border:1px solid #2a3b55; background:#0b1320; color:#c3d5ea; border-radius:6px; padding:2px 6px}
  .right{margin-left:auto}
</style>
</head>
<body>
<div class="shell">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidehead">
      <button class="btn pill" id="newChatBtn">+ Yeni Sohbet</button>
      <button class="btn ghost pill" id="exportBtn">Dƒ±≈üa Aktar</button>
      <button class="btn ghost pill" id="keyBtn">API Anahtarƒ±</button>
    </div>
    <div class="chats" id="chatList"></div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="header">
      <div class="left">
        <div class="brand"><div class="logo"></div><h1>XENAI ‚Äî Akƒ±llƒ± Sohbet</h1></div>
        <span class="badgelite">v1</span>
      </div>
      <div class="controls">
        <select id="model">
          <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
          <option value="gpt-4o">gpt-4o</option>
          <option value="gpt-4.1-mini">gpt-4.1-mini</option>
        </select>
        <input id="system" type="text" placeholder="Sistem y√∂nergesi (√∂rn: T√ºrk√ße, kƒ±sa ve net, tablo kullan)" />
        <button class="btn ghost" id="clearBtn">Temizle</button>
      </div>
    </div>

    <div class="toolbar">
      <span class="chip">Model: <b id="mdlBadge">gpt-4o-mini</b></span>
      <span class="chip">Akƒ±≈ü: <b id="streamBadge">A√ßƒ±k</b></span>
      <div class="tips">
        <span class="tip">‚åò/Ctrl + Enter ‚Üí G√∂nder</span>
        <span class="tip">Shift + Enter ‚Üí Satƒ±r</span>
        <span class="tip">/new, /clear, /summarize</span>
      </div>
    </div>

    <div id="chat" aria-live="polite"></div>

    <div class="composer">
      <button class="icbtn" id="micBtn" title="Dikte (beta)">üéôÔ∏è</button>
      <textarea id="input" placeholder="Mesajƒ±nƒ± yaz‚Ä¶"></textarea>
      <button class="btn send" id="sendBtn">G√∂nder</button>
    </div>
  </main>
</div>

<!-- API Key Modal -->
<div class="modal" id="keyModal">
  <div class="box">
    <h2>OpenAI API Anahtarƒ±</h2>
    <div class="row">
      <input id="apiKeyInput" type="password" placeholder="√∂r. sk-proj-..." />
      <button class="btn" id="saveKeyBtn">Kaydet</button>
      <button class="btn ghost" id="closeKeyBtn">Kapat</button>
    </div>
    <div class="hint">ƒ∞pucu: <span class="kbd">Ctrl/Cmd</span> + <span class="kbd">Enter</span> ile kaydedebilirsin.</div>
  </div>
</div>

<script>
/* ====================== XENAI Core ====================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/* Elements */
const chatEl = $("#chat");
const inputEl = $("#input");
const sendBtn = $("#sendBtn");
const clearBtn = $("#clearBtn");
const newChatBtn = $("#newChatBtn");
const exportBtn = $("#exportBtn");
const modelSel = $("#model");
const systemEl = $("#system");
const mdlBadge = $("#mdlBadge");
const streamBadge = $("#streamBadge");
const micBtn = $("#micBtn");

/* Key Modal */
const keyModal = $("#keyModal");
const apiKeyInput = $("#apiKeyInput");
const saveKeyBtn = $("#saveKeyBtn");
const closeKeyBtn = $("#closeKeyBtn");
const keyBtn = $("#keyBtn");

/* Sidebar list */
const chatList = $("#chatList");

/* Local Storage keys */
const LS_API_KEY = "xenai_api_key";
const LS_CHATS = "xenai_chats_v1";
const LS_ACTIVE = "xenai_active_id";

/* App State */
let state = {
  chats: {},      // id: { id, title, sys, model, msgs: [ {role, content, ts} ] }
  activeId: null,
  streaming: true
};

/* ===== Utils ===== */
function uuid(){ return "c"+Math.random().toString(36).slice(2)+Date.now().toString(36) }
function esc(s){ return s.replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]) ) }
function cleanKey(k){ return (k||"").replace(/[^\x20-\x7E]/g,"").replace(/\s+/g,"").replace(/\.$/,"") }
function getKey(){ return cleanKey(localStorage.getItem(LS_API_KEY)||"") }
function setKey(k){ localStorage.setItem(LS_API_KEY, cleanKey(k)) }
function saveState(){
  localStorage.setItem(LS_CHATS, JSON.stringify(state.chats));
  localStorage.setItem(LS_ACTIVE, state.activeId || "");
}
function loadState(){
  try{ state.chats = JSON.parse(localStorage.getItem(LS_CHATS)||"{}") }catch{ state.chats={} }
  state.activeId = localStorage.getItem(LS_ACTIVE) || null;
  if(!state.activeId || !state.chats[state.activeId]){
    const id = createChat("Yeni Sohbet");
    setActive(id);
  }
  renderChatList();
}
function formatTime(ts){ try{ return new Date(ts).toLocaleString() }catch{ return "" } }

/* ===== Markdown-lite render ===== */
function mdLite(t){
  // triple backticks code blocks
  t = t.replace(/```([\s\S]*?)```/g, (_, code)=> `<pre><code>${esc(code)}</code></pre>`);
  // inline code
  t = t.replace(/`([^`]+)`/g, "<code>$1</code>");
  // bold/italic
  t = t.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
  t = t.replace(/\*([^*]+)\*/g, "<em>$1</em>");
  // lists
  t = t.replace(/^\s*[-‚Ä¢]\s+(.*)$/gm, "<li>$1</li>");
  t = t.replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>");
  // links
  t = t.replace(/(https?:\/\/[^\s)]+)|(www\.[^\s)]+)/g, url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
  // newlines
  t = t.replace(/\n/g, "<br>");
  return t;
}

/* ===== UI Builders ===== */
function addMsg(role, content, opts={}){
  const row = document.createElement("div");
  row.className = "msg " + (role === "user" ? "user" : "bot");
  row.innerHTML = `
    <div class="b">${role==="user"?"üßë":"ü§ñ"}</div>
    <div class="bubble">${mdLite(content||"")}</div>
  `;
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;

  // meta + actions
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `<span>${role==="user"?"Kullanƒ±cƒ±":"XENAI"}</span> ‚Ä¢ <span>${formatTime(Date.now())}</span>`;
  const acts = document.createElement("div"); acts.className = "act";
  const copy = document.createElement("button"); copy.className="action"; copy.textContent="Kopyala";
  copy.onclick = () => navigator.clipboard.writeText(content||"");
  acts.appendChild(copy);

  if(role==="assistant"){
    const regen = document.createElement("button"); regen.className="action"; regen.textContent="Yeniden √úret";
    regen.onclick = () => regenerateLast();
    acts.appendChild(regen);
    const speak = document.createElement("button"); speak.className="action"; speak.textContent="Seslendir";
    speak.onclick = () => speakText(content||"");
    acts.appendChild(speak);
  }

  meta.appendChild(acts);
  chatEl.appendChild(meta);
  chatEl.scrollTop = chatEl.scrollHeight;
  return row;
}
let typingRow = null;
function showTyping(){
  typingRow = document.createElement("div");
  typingRow.className = "msg bot";
  typingRow.innerHTML = `
    <div class="b">ü§ñ</div>
    <div class="bubble"><span class="spin"></span> Yazƒ±yor‚Ä¶</div>
  `;
  chatEl.appendChild(typingRow);
  chatEl.scrollTop = chatEl.scrollHeight;
}
function updateTyping(html){
  if(!typingRow) return;
  typingRow.querySelector(".bubble").innerHTML = html;
  chatEl.scrollTop = chatEl.scrollHeight;
}
function hideTyping(){ if(typingRow){ typingRow.remove(); typingRow=null } }

/* ===== Chats ===== */
function createChat(title="Yeni Sohbet"){
  const id = uuid();
  state.chats[id] = { id, title, sys:"", model:modelSel.value, msgs:[] };
  return id;
}
function setActive(id){
  state.activeId = id;
  const ch = state.chats[id];
  modelSel.value = ch.model || "gpt-4o-mini";
  systemEl.value = ch.sys || "";
  mdlBadge.textContent = modelSel.value;
  renderChatList();
  renderChat();
  saveState();
}
function renderChat(){
  chatEl.innerHTML = "";
  const ch = state.chats[state.activeId];
  if(!ch) return;
  if(ch.msgs.length === 0){
    addMsg("assistant", "Merhaba! Ben <strong>XENAI</strong>. Saƒü √ºstten <em>API anahtarƒ±nƒ±</em> gir, model/sistem ayarƒ±nƒ± yap ve mesaj yaz. Ba≈ülangƒ±√ß i√ßin fikirler:<br>- ‚ÄúBana 7 g√ºnl√ºk beslenme planƒ± olu≈ütur (kalori hedefi 2200).‚Äù<br>- ‚ÄúBu metni kƒ±sa ve profesyonel hale getir.‚Äù<br>- ‚ÄúB1 seviyesinde 12 repliklik diyalog yaz: restoran rezervasyon.‚Äù");
  }else{
    for(const m of ch.msgs){ addMsg(m.role, m.content) }
  }
  chatEl.scrollTop = chatEl.scrollHeight;
}
function renameActive(title){
  const ch = state.chats[state.activeId];
  if(!ch) return;
  ch.title = title || ch.title;
  saveState(); renderChatList();
}
function renderChatList(){
  chatList.innerHTML = "";
  const ids = Object.keys(state.chats);
  for(const id of ids){
    const ch = state.chats[id];
    const item = document.createElement("div");
    item.className = "chatitem"+(id===state.activeId?" active":"");
    item.innerHTML = `<div class="t">${esc(ch.title||"Sohbet")}</div><div class="m">${esc((ch.msgs[ch.msgs.length-1]?.content||"").slice(0,80))}</div>`;
    item.onclick = () => setActive(id);
    chatList.appendChild(item);
  }
}

/* ===== Speech (browser) ===== */
let recog=null, recogOn=false;
function initSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ micBtn.disabled = true; micBtn.title = "Tarayƒ±cƒ±n desteklemiyor"; return }
  recog = new SR(); recog.lang = "tr-TR"; recog.interimResults = true; recog.continuous = true;
  recog.onresult = e=>{
    let t = ""; for(const r of e.results){ t += r[0].transcript }
    inputEl.value = t.trim();
  };
  recog.onend = ()=>{ if(recogOn){ recog.start() } }
}
function toggleRec(){
  if(!recog) return;
  recogOn = !recogOn;
  if(recogOn){ recog.start(); micBtn.textContent="üõë"; micBtn.title="Dikteyi durdur" }
  else { recog.stop(); micBtn.textContent="üéôÔ∏è"; micBtn.title="Dikte (beta)" }
}
function speakText(t){
  try{
    const u = new SpeechSynthesisUtterance(t);
    u.lang = "tr-TR";
    speechSynthesis.speak(u);
  }catch{}
}

/* ===== OpenAI Calls ===== */
async function sendMessage(text){
  // Commands
  if(/^\/new/.test(text)){ const id=createChat("Yeni Sohbet"); setActive(id); return }
  if(/^\/clear/.test(text)){ const ch=state.chats[state.activeId]; ch.msgs=[]; renderChat(); saveState(); return }
  if(/^\/summarize/.test(text)){ summarizeChat(); return }

  const ch = state.chats[state.activeId];
  const sys = (systemEl.value||"").trim();
  if(ch.msgs.length===0 && sys){ ch.sys = sys }

  // Push user message
  ch.msgs.push({ role:"user", content:text, ts:Date.now() });
  addMsg("user", text);
  saveState();

  // Build messages for Chat Completions
  const messages = [];
  const systemText = ch.sys || "T√ºrk√ße yanƒ±tla. Kƒ±sa ve net ol; gerekiyorsa tablo/ba≈ülƒ±k kullan.";
  messages.push({ role:"system", content: systemText });
  for(const m of ch.msgs){
    messages.push({ role: m.role, content: m.content });
  }

  // Call OpenAI
  const key = getKey();
  if(!key || !key.startsWith("sk-")){ addMsg("assistant","‚ö†Ô∏è API anahtarƒ±nƒ± gir: sol taraftaki **API Anahtarƒ±** butonundan.",""); return }
  const model = modelSel.value;
  const stream = state.streaming;

  showTyping();
  try{
    // Prefer Chat Completions (stabil) with stream; fallback to Responses
    const ccBody = { model, messages, temperature:0.7, stream };
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method:"POST",
      headers:{ "Authorization":"Bearer "+key.trim(), "Content-Type":"application/json" },
      body: JSON.stringify(ccBody)
    });

    if(!res.ok){
      // fallback non-stream CC or Responses
      hideTyping();
      const txt = await res.text().catch(()=> "");
      addMsg("assistant", `‚ö†Ô∏è Hata ${res.status}<br><code>${esc(txt.slice(0,600))}</code>`);
      return;
    }

    if(stream){
      await streamCC(res, ch);
    }else{
      const data = await res.json();
      const answer = data?.choices?.[0]?.message?.content || "(bo≈ü)";
      hideTyping();
      addAssistant(answer, ch);
    }
  }catch(err){
    hideTyping();
    addMsg("assistant", "‚ö†Ô∏è Aƒü/istemci hatasƒ±: "+esc(err.message||String(err)));
  }
}

async function streamCC(res, ch){
  // SSE-ish event stream for chat/completions
  const reader = res.body.getReader();
  const decoder = new TextDecoder("utf-8");
  let done = false, buffer = "", acc = "";

  updateTyping("<span class='spin'></span> Yazƒ±yor‚Ä¶");
  while(!done){
    const {value, done:doneNow} = await reader.read();
    done = doneNow;
    if(value){
      buffer += decoder.decode(value, {stream:true});
      const parts = buffer.split("\n\n");
      buffer = parts.pop() || "";
      for(const p of parts){
        const line = p.trim();
        if(!line.startsWith("data:")) continue;
        const jsonStr = line.slice(5).trim();
        if(jsonStr === "[DONE]") continue;
        try{
          const evt = JSON.parse(jsonStr);
          const delta = evt?.choices?.[0]?.delta?.content || "";
          if(delta){
            acc += delta;
            updateTyping(mdLite(acc));
          }
        }catch{}
      }
    }
  }
  hideTyping();
  if(acc.trim()){
    addAssistant(acc, ch);
  }else{
    addMsg("assistant","(bo≈ü yanƒ±t) ‚Äî L√ºtfen tekrar deneyin.");
  }
}

function addAssistant(answer, ch){
  addMsg("assistant", answer);
  ch.msgs.push({ role:"assistant", content:answer, ts:Date.now() });
  // title auto
  if((ch.title||"Yeni Sohbet")==="Yeni Sohbet"){
    const first = (ch.msgs.find(m=>m.role==="user")?.content||"").slice(0,40);
    renameActive(first || "XENAI Sohbeti");
  }
  saveState();
}

/* ===== Regenerate last ===== */
async function regenerateLast(){
  const ch = state.chats[state.activeId];
  if(!ch || ch.msgs.length===0) return;
  const lastUserIdx = [...ch.msgs].map((m,i)=>({m,i})).reverse().find(x=>x.m.role==="user")?.i;
  if(lastUserIdx==null) return;
  const text = ch.msgs[lastUserIdx].content;
  // remove trailing assistant(s)
  ch.msgs = ch.msgs.slice(0, lastUserIdx+1);
  renderChat();
  await sendMessage(text);
}

/* ===== Summarize chat ===== */
async function summarizeChat(){
  const ch = state.chats[state.activeId];
  if(!ch || ch.msgs.length===0){ addMsg("assistant","√ñzetlenecek mesaj yok."); return }
  const plain = ch.msgs.map(m=>`${m.role.toUpperCase()}: ${m.content}`).join("\n");
  await sendMessage("Bu konu≈ümayƒ± 10 madde ve 5 aksiyonla √∂zetle:\n\n"+plain.slice(-5000));
}

/* ===== Export ===== */
function exportChat(){
  const ch = state.chats[state.activeId];
  if(!ch) return;
  const lines = [];
  lines.push(`# XENAI Sohbet: ${ch.title}`);
  lines.push(`Model: ${ch.model}  |  Tarih: ${new Date().toLocaleString()}`);
  lines.push(`Sistem: ${ch.sys||"(varsayƒ±lan)"}`);
  lines.push(`---\n`);
  for(const m of ch.msgs){
    lines.push(`**${m.role.toUpperCase()}** ‚Äî ${new Date(m.ts).toLocaleString()}\n\n${m.content}\n`);
  }
  const blob = new Blob([lines.join("\n")], {type:"text/markdown"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `xenai_${Date.now()}.md`; a.click();
  URL.revokeObjectURL(url);
}

/* ====================== Events ====================== */
sendBtn.onclick = () => {
  const t = inputEl.value.trim(); if(!t) return;
  inputEl.value = "";
  sendMessage(t);
};
inputEl.addEventListener("keydown", e=>{
  if(e.key==="Enter" && (e.metaKey||e.ctrlKey)){ e.preventDefault(); sendBtn.click() }
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendBtn.click() }
});
clearBtn.onclick = ()=>{ const ch=state.chats[state.activeId]; if(!ch) return; ch.msgs=[]; renderChat(); saveState() };
newChatBtn.onclick = ()=>{ const id=createChat("Yeni Sohbet"); setActive(id) };
exportBtn.onclick = exportChat;
modelSel.onchange = ()=>{ const ch=state.chats[state.activeId]; if(!ch) return; ch.model=modelSel.value; mdlBadge.textContent=modelSel.value; saveState() };
systemEl.onchange = ()=>{ const ch=state.chats[state.activeId]; if(!ch) return; ch.sys=systemEl.value; saveState() };
micBtn.onclick = toggleRec;

/* Key Modal */
function openKeyModal(){ keyModal.classList.add("show"); apiKeyInput.value=getKey(); apiKeyInput.focus() }
function closeKeyModal(){ keyModal.classList.remove("show") }
keyBtn.onclick = openKeyModal; saveKeyBtn.onclick = ()=>{ setKey(apiKeyInput.value); closeKeyModal() }; closeKeyBtn.onclick = closeKeyModal;
apiKeyInput.addEventListener("keydown", e=>{ if((e.key==="Enter")&&(e.metaKey||e.ctrlKey)) saveKeyBtn.click() });

/* First run */
(function init(){
  loadState();
  initSpeech();
  if(!getKey()) openKeyModal();
  addKeyboardToggles();
})();

/* Convenience: toggle streaming with double-click on model badge */
function addKeyboardToggles(){
  mdlBadge.addEventListener("dblclick", ()=>{
    state.streaming = !state.streaming;
    streamBadge.textContent = state.streaming ? "A√ßƒ±k" : "Kapalƒ±";
  });
}
</script>
</body>
</html>

