<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>XENAI — Intelligent Assistant</title>
<meta name="theme-color" content="#0b0f14" />
<style>
  :root{
    --bg:#070b10; --panel:#0d1420; --panel2:#0b1220; --line:#162233;
    --text:#e6eef6; --muted:#9fb0c7; --acc:#22d3ee; --acc2:#7c3aed;
    --chip:#0b1320; --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 800px at -10% -10%, rgba(34,211,238,.14), transparent 60%),
      radial-gradient(1200px 800px at 110% 110%, rgba(124,58,237,.12), transparent 60%),
      linear-gradient(180deg, #090d13, #0a0f15);
    font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  }

  /* Layout */
  .shell{display:grid; grid-template-rows:64px 1fr 64px; height:100%}
  .header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 14px; border-bottom:1px solid var(--line);
    background: linear-gradient(180deg, rgba(34,211,238,.06), transparent);
  }
  .brand{display:flex; align-items:center; gap:12px}
  .logo{
    width:36px; height:36px; border-radius:12px; position:relative;
    background: conic-gradient(from 90deg, var(--acc), var(--acc2) 40%, #34d399 75%, var(--acc));
    box-shadow: 0 0 28px rgba(34,211,238,.35), inset 0 0 18px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .logo::after{
    content:""; position:absolute; inset:6px; border-radius:10px;
    background: radial-gradient(120px 60px at 40% 30%, rgba(255,255,255,.25), transparent 40%);
    filter: blur(8px);
  }
  .brand h1{font-size:16px; letter-spacing:.3px; margin:0}

  .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  select{
    background:#0b1320; color:var(--text); border:1px solid #223249; border-radius:12px;
    height:38px; padding:6px 12px; outline:none
  }
  .btn{
    height:38px; padding:0 14px; border-radius:12px; font-weight:700; cursor:pointer; border:1px solid #234;
    color:#071a1a; background:linear-gradient(180deg,#27e0cc,#1bc2b5);
  }
  .btn.ghost{background:#0b1320; color:var(--text); border-color:#243247}
  .avatar{width:34px; height:34px; border-radius:50%; border:1px solid #263b56; object-fit:cover}

  /* Chat area */
  .main{display:grid; grid-template-columns: minmax(0,1fr); height:100%}
  #chatWrap{position:relative; height:100%; overflow:auto; scroll-behavior:smooth; padding:14px}
  #chat{max-width:980px; margin:0 auto}

  .msg{display:flex; gap:12px; margin:12px 0; align-items:flex-start}
  .b{flex:0 0 40px; height:40px; border-radius:12px; display:grid; place-items:center; background:#0b1320; border:1px solid #213047}
  .user .b{background:#192433}
  .bot .b{background:#0b3b32; border-color:#0b3b32}
  .bubble{padding:12px 14px; border-radius:16px; max-width:82%;
          border:1px solid #1f2a3d; background:#0e1520}
  .user .bubble{background:#131b2a}
  .bot .bubble{background:#0a2e27; border-color:#0a3a33}
  .meta{display:flex; gap:8px; align-items:center; color:#a2b5ca; font-size:12px; margin:6px 0 0 52px}
  .act{display:flex; gap:6px; margin-left:auto}
  .action{font-size:12px; padding:4px 8px; border-radius:8px; border:1px solid #264; background:#0d1b1a; color:#a7f3d0; cursor:pointer}

  /* Composer */
  .composer{display:flex; gap:10px; padding:12px; border-top:1px solid var(--line); background:#0e1520}
  textarea{flex:1; min-height:52px; max-height:220px; resize:none; padding:12px; border-radius:14px;
           background:#0b1320; color:var(--text); border:1px solid #243247; outline:none}
  .send{min-width:140px}
  .icbtn{height:44px; min-width:44px; display:grid; place-items:center; border-radius:12px;
         border:1px solid #243247; background:#0b1320; color:#cce3ff; cursor:pointer}

  /* Code & markdown */
  pre{background:#0b1320; border:1px solid #243247; padding:10px; border-radius:10px; overflow:auto}
  code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .bubble h1,.bubble h2,.bubble h3{margin:.4em 0}
  .bubble ul{margin:.3em 0 .3em 1.2em}
  a{color:#7dd3fc; text-decoration:none} a:hover{text-decoration:underline}
  .spin{display:inline-block;width:16px;height:16px;border:2px solid #a7f3d0;border-right-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Jump to latest */
  #jump{position:sticky; bottom:12px; margin-top:-36px; display:none; z-index:2}
  #jump button{margin:0 auto; display:block; background:#0b1320; border:1px solid #223047; color:#d2f3ff;
               padding:8px 12px; border-radius:999px; cursor:pointer}

  /* Auth modal */
  .modal{position:fixed; inset:0; background:rgba(3,6,10,.66); display:none; place-items:center; z-index:20}
  .modal.show{display:grid}
  .box{width:min(520px,92%); background:#0e1623; border:1px solid #203049; border-radius:16px; padding:18px}
  .box h2{margin:0 0 8px 0; font-size:18px}
  .row{display:flex; gap:10px; align-items:center; margin:10px 0}
  .note{font-size:13px; color:var(--muted)}
  .sep{height:1px; background:#1e2b40; margin:10px 0}
</style>
</head>
<body>
<div class="shell">
  <!-- Header -->
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>XENAI — Intelligent Assistant</h1>
    </div>
    <div class="controls">
      <select id="model">
        <option value="xen-5.1" selected>XEN 5.1 (Fast)</option>
        <option value="xen-5.2">XEN 5.2 (Balanced)</option>
        <option value="xen-5.3">XEN 5.3 (Advanced)</option>
      </select>
      <button class="btn ghost" id="resetBtn" title="Start fresh">Reset</button>
      <img id="avatar" class="avatar" src="" alt="" style="display:none" />
      <button class="btn" id="signinBtn">Sign in</button>
      <button class="btn ghost" id="signoutBtn" style="display:none">Sign out</button>
    </div>
  </header>

  <!-- Chat -->
  <main class="main">
    <div id="chatWrap">
      <div id="chat" aria-live="polite"></div>
      <div id="jump"><button id="jumpBtn">Jump to latest ↓</button></div>
    </div>
  </main>

  <!-- Composer -->
  <footer class="composer">
    <textarea id="input" placeholder="Type your message…" autocomplete="off"></textarea>
    <button class="btn send" id="sendBtn">Send</button>
  </footer>
</div>

<!-- Auth Modal -->
<div class="modal" id="authModal">
  <div class="box">
    <h2>Welcome to XENAI</h2>
    <p class="note">Sign in to sync your conversations across devices. You can also continue as a guest.</p>
    <div class="row">
      <button class="btn" id="googleBtn">Continue with Google</button>
      <button class="btn ghost" id="anonBtn">Continue as Guest</button>
    </div>
    <div class="sep"></div>
    <p class="note">By continuing you agree to our basic usage terms. You can sign out anytime.</p>
  </div>
</div>

<script type="module">
/* ================== Firebase (Auth + Firestore + Analytics) ================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, enableIndexedDbPersistence, collection, addDoc, doc, setDoc, getDoc, onSnapshot, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* ====== CONFIG: Replace with your Firebase project (provided) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDXQlb8jReShQmtOuCWPKg4G5ctO0kXE9E",
  authDomain: "xenai-cf2ce.firebaseapp.com",
  projectId: "xenai-cf2ce",
  storageBucket: "xenai-cf2ce.firebasestorage.app",
  messagingSenderId: "492168745931",
  appId: "1:492168745931:web:32c153a356794621abdc4e",
  measurementId: "G-EC555NNNY4"
};

const app = initializeApp(firebaseConfig);
try { getAnalytics(app); } catch(e) { /* analytics optional in some envs */ }

const auth = getAuth(app);
const db = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{});

/* ================== OpenAI Call (stream) ================== */
/* Replace the key below in CODE (no UI for key input) */
const OPENAI_API_KEY = "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";

/* Model mapping: never show real model names in UI */
const MODEL_MAP = {
  "xen-5.1": "gpt-4o-mini",
  "xen-5.2": "gpt-4o",
  "xen-5.3": "gpt-4.1-mini"
};

/* Hidden system behavior (not shown in UI) */
const SYSTEM_DEFAULT = "You are XENAI. Reply in clear, helpful English. Use Markdown when it improves readability. Be concise.";

/* ================== DOM refs ================== */
const $ = s => document.querySelector(s);
const chatWrap = $("#chatWrap");
const chat = $("#chat");
const input = $("#input");
const sendBtn = $("#sendBtn");
const modelSel = $("#model");
const resetBtn = $("#resetBtn");
const signinBtn = $("#signinBtn");
const signoutBtn = $("#signoutBtn");
const avatarImg = $("#avatar");
const authModal = $("#authModal");
const googleBtn = $("#googleBtn");
const anonBtn = $("#anonBtn");
const jump = $("#jump"), jumpBtn = $("#jumpBtn");

/* ================== App State ================== */
let uid = null;
let messages = []; // {role, content, ts}
let unsub = null;
let isStreaming = false;

/* ================== Utils ================== */
function esc(s){ return (s||"").replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }
function mdLite(t){
  t = (t||"");
  t = t.replace(/```([\s\S]*?)```/g, (_, code)=> `<pre><code>${esc(code)}</code></pre>`);
  t = t.replace(/`([^`]+)`/g, "<code>$1</code>");
  t = t.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
  t = t.replace(/\*([^*]+)\*/g, "<em>$1</em>");
  t = t.replace(/^\s*[-•]\s+(.*)$/gm, "<li>$1</li>");
  t = t.replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>");
  t = t.replace(/(https?:\/\/[^\s)]+)|(www\.[^\s)]+)/g, url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
  t = t.replace(/\n/g, "<br>");
  return t;
}
function addMsg(role, content){
  const row = document.createElement("div");
  row.className = "msg " + (role === "user" ? "user" : "bot");
  row.innerHTML = `
    <div class="b">${role==="user"?"🧑":"🤖"}</div>
    <div class="bubble">${mdLite(content||"")}</div>
  `;
  chat.appendChild(row);
  smartScroll();
  const meta = document.createElement("div");
  meta.className = "meta";
  const actions = document.createElement("div"); actions.className = "act";
  const copy = document.createElement("button"); copy.className="action"; copy.textContent="Copy";
  copy.onclick = ()=> navigator.clipboard.writeText(content||"");
  actions.appendChild(copy);
  meta.innerHTML = `<span>${role==="user"?"You":"XENAI"}</span>`;
  meta.appendChild(actions);
  chat.appendChild(meta);
  smartScroll();
  return row;
}
let typingRow = null;
function showTyping(){
  typingRow = document.createElement("div");
  typingRow.className = "msg bot";
  typingRow.innerHTML = `
    <div class="b">🤖</div>
    <div class="bubble"><span class="spin"></span> Typing…</div>
  `;
  chat.appendChild(typingRow);
  smartScroll();
}
function updateTyping(html){
  if(!typingRow) return;
  typingRow.querySelector(".bubble").innerHTML = html;
  smartScroll();
}
function hideTyping(){ if(typingRow){ typingRow.remove(); typingRow=null } }

/* Smart scroll: stick only if near bottom; show "Jump to latest" otherwise */
function nearBottom(){
  const delta = chatWrap.scrollHeight - chatWrap.scrollTop - chatWrap.clientHeight;
  return delta < 120;
}
function smartScroll(){
  if(nearBottom()){ chatWrap.scrollTop = chatWrap.scrollHeight; jump.style.display="none"; }
  else { jump.style.display="block"; }
}
chatWrap.addEventListener("scroll", ()=>{
  if(nearBottom()) jump.style.display="none";
});
jumpBtn.onclick = ()=>{ chatWrap.scrollTop = chatWrap.scrollHeight; };

/* ================== OpenAI Streaming ================== */
async function askXENAI(modelKey, msgs){
  const apiModel = MODEL_MAP[modelKey] || MODEL_MAP["xen-5.1"];
  const headers = { "Authorization":"Bearer "+OPENAI_API_KEY, "Content-Type":"application/json" };
  const body = {
    model: apiModel,
    messages: [{ role:"system", content: SYSTEM_DEFAULT }, ...msgs],
    temperature: 0.7,
    stream: true
  };

  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method:"POST", headers, body: JSON.stringify(body)
  });
  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error("HTTP "+res.status+" — "+txt.slice(0,300));
  }
  return res.body.getReader();
}

/* ================== Firestore helpers ================== */
function userPath(){
  if(!uid) return null;
  return {
    convRef: doc(db, "users", uid, "conversations", "main"),
    msgsRef: collection(db, "users", uid, "conversations", "main", "messages")
  };
}
async function ensureUser(){
  const u = auth.currentUser;
  if(!u) return;
  const userRef = doc(db, "users", u.uid);
  const docSnap = await getDoc(userRef);
  if(!docSnap.exists()){
    await setDoc(userRef, { createdAt: serverTimestamp() });
  }
  const { convRef } = userPath();
  const convSnap = await getDoc(convRef);
  if(!convSnap.exists()){
    await setDoc(convRef, { title: "Main", createdAt: serverTimestamp() });
  }
}
async function appendToFirestore(role, content){
  if(!uid) return;
  const { msgsRef } = userPath();
  await addDoc(msgsRef, { role, content, ts: serverTimestamp() });
}
function startListening(){
  if(!uid) return;
  const { msgsRef } = userPath();
  const q = query(msgsRef, orderBy("ts","asc"), limit(200));
  unsub = onSnapshot(q, snap=>{
    chat.innerHTML = "";
    messages = [];
    snap.forEach(d=>{
      const m = d.data();
      messages.push({ role: m.role, content: m.content, ts: m.ts?.toMillis?.() || Date.now() });
    });
    if(messages.length===0){
      addMsg("assistant", "Hello, I'm <strong>XENAI</strong>. Ask me anything or paste your content. I’ll respond with clear, structured answers when helpful.");
    }else{
      for(const m of messages) addMsg(m.role==="user"?"user":"assistant", m.content);
    }
  });
}

/* ================== Auth ================== */
onAuthStateChanged(auth, async (user)=>{
  if(user){
    uid = user.uid;
    avatarImg.style.display = user.photoURL ? "inline-block" : "none";
    if(user.photoURL){ avatarImg.src = user.photoURL; avatarImg.alt = user.displayName||"User"; }
    signinBtn.style.display = "none";
    signoutBtn.style.display = "inline-block";
    authModal.classList.remove("show");
    await ensureUser();
    if(unsub) unsub();
    startListening();
  }else{
    uid = null;
    avatarImg.style.display = "none";
    signinBtn.style.display = "inline-block";
    signoutBtn.style.display = "none";
    authModal.classList.add("show");
    // clear local display (not Firestore)
    chat.innerHTML = "";
    messages = [];
    addMsg("assistant", "Welcome to <strong>XENAI</strong>. Sign in or continue as guest to begin.");
  }
});

signinBtn.onclick = ()=> authModal.classList.add("show");
signoutBtn.onclick = ()=> signOut(auth);
googleBtn.onclick = async ()=>{
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
};
anonBtn.onclick = async ()=>{ await signInAnonymously(auth); };

/* ================== Send flow ================== */
sendBtn.onclick = async ()=>{
  const text = input.value.trim();
  if(!text) return;
  input.value = "";

  // local echo
  addMsg("user", text);
  appendToFirestore("user", text).catch(()=>{});

  // build message history (limited)
  const hist = [...messages, { role:"user", content:text }].slice(-20).map(m=>({ role: m.role==="assistant"?"assistant":"user", content:m.content }));

  // call
  showTyping();
  isStreaming = true;
  try{
    const reader = await askXENAI(modelSel.value, hist);
    const decoder = new TextDecoder("utf-8");
    let done = false, buffer = "", acc = "";
    while(!done){
      const { value, done:doneNow } = await reader.read();
      done = doneNow;
      if(value){
        buffer += decoder.decode(value, {stream:true});
        const chunks = buffer.split("\n\n");
        buffer = chunks.pop() || "";
        for(const ch of chunks){
          const line = ch.trim();
          if(!line.startsWith("data:")) continue;
          const jsonStr = line.slice(5).trim();
          if(jsonStr === "[DONE]") continue;
          try{
            const evt = JSON.parse(jsonStr);
            const delta = evt?.choices?.[0]?.delta?.content || "";
            if(delta){
              acc += delta;
              updateTyping(mdLite(acc));
            }
          }catch{}
        }
      }
    }
    hideTyping();
    if(!acc.trim()) acc = "(no content)";
    addMsg("assistant", acc);
    appendToFirestore("assistant", acc).catch(()=>{});
  }catch(err){
    hideTyping();
    addMsg("assistant", "⚠️ Error<br><code>"+esc(err.message||String(err))+"</code>");
  }finally{
    isStreaming = false;
  }
};

/* Enter shortcuts */
input.addEventListener("keydown", e=>{
  if(e.key==="Enter" && (e.metaKey||e.ctrlKey)){ e.preventDefault(); sendBtn.click(); }
  else if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
});

/* Reset conversation (UI only + Firestore new thread) */
resetBtn.onclick = async ()=>{
  // Soft-clear UI
  chat.innerHTML = "";
  messages = [];
  addMsg("assistant", "New conversation started. How can I help?");
  // Persist a separator message (optional)
  appendToFirestore("assistant", "— Conversation reset —").catch(()=>{});
};

/* Initial greet (if not signed) */
addMsg("assistant", "Welcome to <strong>XENAI</strong>. Sign in to sync your chats, or continue as guest.");

/* If user is already authenticated (e.g., returning) the listener will render messages */
</script>
</body>
</html>
