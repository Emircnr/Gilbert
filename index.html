<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>XENAI ‚Äî Intelligent Assistant</title>
<meta name="theme-color" content="#0c0f1a" />
<style>
  :root{
    --bg:#0a0f18; --panel:#0e1524; --panel2:#0b1222; --glass:rgba(14,21,36,.62);
    --line:#17243a; --text:#e9f1ff; --muted:#9fb0c7; --acc:#22d3ee; --acc2:#8b5cf6; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    background:
      radial-gradient(1200px 800px at -10% -10%, rgba(34,211,238,.14), transparent 60%),
      radial-gradient(1200px 800px at 110% 120%, rgba(139,92,246,.12), transparent 60%),
      linear-gradient(180deg, #070b12, #0a0f18);
    font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    letter-spacing:.2px;
  }

  /* ============ Layout ============ */
  .grid{
    display:grid; grid-template-columns: 320px 1fr; grid-template-rows: 72px 1fr 78px; height:100%;
  }
  header{
    grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:14px 18px; border-bottom:1px solid var(--line);
    background:linear-gradient(180deg, rgba(34,211,238,.06), transparent);
    position:sticky; top:0; z-index:3;
  }
  .brand{display:flex; align-items:center; gap:14px}
  .logo{
    width:40px;height:40px;border-radius:14px;position:relative;overflow:hidden;
    background: conic-gradient(from 110deg, var(--acc), var(--acc2) 40%, #34d399 80%, var(--acc));
    box-shadow: 0 0 36px rgba(34,211,238,.35), inset 0 0 18px rgba(0,0,0,.35);
  }
  .logo::after{
    content:""; position:absolute; inset:8px; border-radius:12px;
    background: radial-gradient(120px 60px at 40% 30%, rgba(255,255,255,.25), transparent 40%);
    filter: blur(10px);
  }
  h1{margin:0;font-size:18px;letter-spacing:.4px}
  .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  select{
    background:var(--panel2); color:var(--text); border:1px solid #23314a; border-radius:12px;
    height:40px; padding:8px 12px; outline:none
  }
  .btn{
    height:40px; padding:0 14px; border-radius:12px; font-weight:700; cursor:pointer; border:1px solid #214;
    color:#071a1a; background:linear-gradient(180deg,#27e0cc,#1bc2b5);
  }
  .btn.ghost{background:var(--panel2); color:var(--text); border-color:#23314a}
  .avatar{width:36px;height:36px;border-radius:50%;border:1px solid #263b56;object-fit:cover;display:none}

  /* Sidebar */
  aside{
    grid-row:2/4; border-right:1px solid var(--line);
    background:var(--glass); backdrop-filter: blur(10px);
    display:flex; flex-direction:column; min-height:0;
  }
  .usercard{display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid var(--line)}
  .usercard .info{display:flex; flex-direction:column}
  .usercard .name{font-weight:700; font-size:14px}
  .usercard .sub{color:var(--muted); font-size:12px}
  .sidebar-actions{display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--line)}
  .search{display:flex;gap:8px;padding:10px}
  .search input{
    flex:1;background:var(--panel2); color:var(--text); border:1px solid #23314a; border-radius:12px; padding:10px;
    height:40px; outline:none
  }
  .convs{flex:1; overflow:auto; padding:10px; }
  .conv{
    border:1px solid #1a2a40; background:rgba(11,19,32,.72); border-radius:14px; padding:12px; margin-bottom:10px; cursor:pointer;
    transition:transform .06s ease, background .2s;
  }
  .conv:hover{transform:translateY(-1px); background:#0d1626}
  .conv.active{outline:2px solid var(--acc); background:#0a1524}
  .conv .row{display:flex; align-items:center; gap:8px}
  .conv .title{font-weight:700; font-size:14px}
  .conv .time{margin-left:auto; font-size:11px; color:#8aa0b8}
  .conv .preview{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:4px}
  .conv .pill{border:1px solid #2a3b55;background:#0b1320;color:#cbd6e7;border-radius:999px;padding:2px 8px;font-size:11px}
  .conv .actions{display:flex; gap:6px; margin-left:6px}
  .conv .mini{border:1px solid #2a3b55;background:#0b1320;color:#cbd6e7;border-radius:8px;padding:3px 7px;font-size:11px}

  /* Main chat */
  main{ grid-column:2; grid-row:2; display:flex; flex-direction:column; min-height:0 }
  #chatWrap{position:relative; height:100%; overflow:auto; scroll-behavior:smooth; padding:18px}
  #chat{max-width:980px; margin:0 auto}

  .msg{display:flex; gap:12px; margin:14px 0; align-items:flex-start}
  .b{flex:0 0 42px; height:42px; border-radius:14px; display:grid; place-items:center; background:#0b1320; border:1px solid #213047}
  .user .b{background:#182233}
  .bot .b{background:#0b3b32; border-color:#0b3b32}
  .bubble{padding:14px 16px; border-radius:16px; max-width:82%;
          border:1px solid #1f2a3d; background:#0e1520}
  .user .bubble{background:#121a2c}
  .bot .bubble{background:#0a2e27; border-color:#0a3a33}
  .meta{display:flex; gap:8px; align-items:center; color:#a2b5ca; font-size:12px; margin:6px 0 0 54px}
  .act{display:flex; gap:6px; margin-left:auto}
  .action{font-size:12px; padding:4px 8px; border-radius:8px; border:1px solid #264; background:#0d1b1a; color:#a7f3d0; cursor:pointer}
  pre{background:#0b1320; border:1px solid #243247; padding:12px; border-radius:12px; overflow:auto}
  code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  a{color:#7dd3fc; text-decoration:none} a:hover{text-decoration:underline}

  /* Composer (big like major assistants) */
  footer{ grid-column:2; grid-row:3; }
  .composer{
    display:flex; gap:12px; padding:14px; border-top:1px solid var(--line);
    background:linear-gradient(0deg, rgba(14,21,36,.65), rgba(14,21,36,.65)), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"></svg>');
    backdrop-filter: blur(10px);
  }
  textarea{
    flex:1; min-height:72px; max-height:42vh; resize:none; padding:16px; border-radius:16px;
    background:var(--panel2); color:var(--text); border:1px solid #243247; outline:none; font-size:16px; line-height:1.55;
  }
  .send{min-width:150px}
  .icbtn{height:44px; min-width:44px; display:grid; place-items:center; border-radius:12px;
         border:1px solid #243247; background:#0b1320; color:#cce3ff; cursor:pointer}

  /* Jump to latest */
  #jump{position:sticky; bottom:14px; margin-top:-36px; display:none; z-index:2}
  #jump button{margin:0 auto; display:block; background:#0b1320; border:1px solid #223047; color:#d2f3ff;
               padding:8px 12px; border-radius:999px; cursor:pointer}

  /* Modal (auth) */
  .modal{position:fixed; inset:0; background:rgba(3,6,10,.66); display:none; place-items:center; z-index:20}
  .modal.show{display:grid}
  .box{width:min(560px,92%); background:#0e1623; border:1px solid #203049; border-radius:16px; padding:20px}
  .box h2{margin:0 0 8px 0; font-size:20px}
  .row{display:flex; gap:10px; align-items:center; margin:12px 0}
  .note{font-size:13px; color:var(--muted)}
  .sep{height:1px; background:#1e2b40; margin:12px 0}

  .spin{display:inline-block;width:16px;height:16px;border:2px solid #a7f3d0;border-right-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  @media (max-width: 1100px){ .grid{ grid-template-columns: 1fr; } aside{ display:none } footer{ grid-column:1 } main{ grid-column:1 } }
</style>
</head>
<body>
<div class="grid">
  <!-- Header -->
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>XENAI ‚Äî Intelligent Assistant</h1>
    </div>
    <div class="controls">
      <select id="model">
        <option value="xen-5.1" selected>XEN 5.1 (Fast)</option>
        <option value="xen-5.2">XEN 5.2 (Balanced)</option>
        <option value="xen-5.3">XEN 5.3 (Advanced)</option>
      </select>
      <button class="btn ghost" id="newBtn" title="New conversation">New Chat</button>
      <img id="avatar" class="avatar" src="" alt=""/>
      <button class="btn" id="signinBtn">Sign in</button>
      <button class="btn ghost" id="signoutBtn" style="display:none">Sign out</button>
    </div>
  </header>

  <!-- Sidebar -->
  <aside>
    <div class="usercard">
      <img id="sideAvatar" class="avatar" src="" alt=""/>
      <div class="info">
        <div class="name" id="displayName">Guest</div>
        <div class="sub" id="displayEmail">Not signed in</div>
      </div>
    </div>
    <div class="sidebar-actions">
      <button class="btn" id="sideGoogleBtn">Google</button>
      <button class="btn ghost" id="sideAnonBtn">Guest</button>
    </div>
    <div class="search">
      <input id="search" type="text" placeholder="Search your chats‚Ä¶" />
      <button class="btn ghost" id="sideNewBtn" title="New chat">Ôºã</button>
    </div>
    <div class="convs" id="convs"></div>
  </aside>

  <!-- Main -->
  <main>
    <div id="chatWrap">
      <div id="chat" aria-live="polite"></div>
      <div id="jump"><button id="jumpBtn">Jump to latest ‚Üì</button></div>
    </div>
  </main>

  <!-- Composer -->
  <footer>
    <div class="composer">
      <button class="icbtn" id="micBtn" title="Dictate (beta)">üéôÔ∏è</button>
      <textarea id="input" placeholder="Type your message‚Ä¶" autocomplete="off"></textarea>
      <button class="btn send" id="sendBtn">Send</button>
    </div>
  </footer>
</div>

<!-- Auth Modal -->
<div class="modal" id="authModal">
  <div class="box">
    <h2>Welcome to XENAI</h2>
    <p class="note">Sign in with Google to sync your conversation history. You can also continue as a guest.</p>
    <div class="row">
      <button class="btn" id="googleBtn">Continue with Google</button>
      <button class="btn ghost" id="anonBtn">Continue as Guest</button>
    </div>
    <div class="sep"></div>
    <p class="note">By continuing you agree to basic usage terms. You can sign out anytime.</p>
  </div>
</div>

<script type="module">
/* ================== Firebase (Auth + Firestore + Analytics) ================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, enableIndexedDbPersistence, collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, query, orderBy, limit, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* ====== Your Firebase project ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDXQlb8jReShQmtOuCWPKg4G5ctO0kXE9E",
  authDomain: "xenai-cf2ce.firebaseapp.com",
  projectId: "xenai-cf2ce",
  storageBucket: "xenai-cf2ce.firebasestorage.app",
  messagingSenderId: "492168745931",
  appId: "1:492168745931:web:32c153a356794621abdc4e",
  measurementId: "G-EC555NNNY4"
};

const app = initializeApp(firebaseConfig);
try{ getAnalytics(app); }catch{}
const auth = getAuth(app);
const db = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{});

/* ================== OpenAI (stream) ================== */
/* TODO: Put your real API key here */
const OPENAI_API_KEY = "PUT_YOUR_OPENAI_API_KEY_HERE";

/* UI model names ‚Üí real API models (UI never shows provider/model names) */
const MODEL_MAP = {
  "xen-5.1": "gpt-4o-mini",
  "xen-5.2": "gpt-4o",
  "xen-5.3": "gpt-4.1-mini"
};
const SYSTEM_DEFAULT = "You are XENAI. Reply in clear, helpful English. Use Markdown when useful. Be concise.";

/* ================== DOM refs ================== */
const $ = s => document.querySelector(s);
const chatWrap = $("#chatWrap"); const chat = $("#chat"); const input = $("#input");
const sendBtn = $("#sendBtn"); const modelSel = $("#model");
const signinBtn = $("#signinBtn"); const signoutBtn = $("#signoutBtn"); const avatar = $("#avatar");
const sideAvatar = $("#sideAvatar"); const displayName = $("#displayName"); const displayEmail = $("#displayEmail");
const authModal = $("#authModal"); const googleBtn = $("#googleBtn"); const anonBtn = $("#anonBtn");
const sideGoogleBtn = $("#sideGoogleBtn"); const sideAnonBtn = $("#sideAnonBtn");
const newBtn = $("#newBtn"); const sideNewBtn = $("#sideNewBtn");
const convsEl = $("#convs"); const searchEl = $("#search");
const jump = $("#jump"); const jumpBtn = $("#jumpBtn"); const micBtn = $("#micBtn");

/* ================== State ================== */
let uid = null;
let activeConvId = null;
let unsubConvs = null, unsubMsgs = null;
let messages = []; // current chat messages
const LS_ACTIVE = "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";

/* ================== Helpers ================== */
function esc(s){ return (s||"").replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;","&": "&amp;", ">":"&gt;"}[m])); }
function mdLite(t){
  t = (t||"");
  t = t.replace(/```([\s\S]*?)```/g, (_, code)=> `<pre><code>${esc(code)}</code></pre>`);
  t = t.replace(/`([^`]+)`/g, "<code>$1</code>");
  t = t.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
  t = t.replace(/\*([^*]+)\*/g, "<em>$1</em>");
  t = t.replace(/^\s*[-‚Ä¢]\s+(.*)$/gm, "<li>$1</li>");
  t = t.replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>");
  t = t.replace(/(https?:\/\/[^\s)]+)|(www\.[^\s)]+)/g, url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
  t = t.replace(/\n/g, "<br>");
  return t;
}
function trunc(s,n){ s=s||""; return s.length>n? s.slice(0,n)+"‚Ä¶" : s }
function fmtTime(ts){ try{ return new Date(ts).toLocaleString(); }catch{ return "" } }

/* Message rows */
function addMsg(role, content){
  const row = document.createElement("div");
  row.className = "msg " + (role==="user" ? "user" : "bot");
  row.innerHTML = `<div class="b">${role==="user"?"üßë":"ü§ñ"}</div><div class="bubble">${mdLite(content||"")}</div>`;
  chat.appendChild(row);
  smartScroll();
  const meta = document.createElement("div");
  meta.className = "meta";
  const actions = document.createElement("div"); actions.className = "act";
  const copy = document.createElement("button"); copy.className="action"; copy.textContent="Copy";
  copy.onclick = ()=> navigator.clipboard.writeText(content||"");
  actions.appendChild(copy);
  meta.innerHTML = `<span>${role==="user"?"You":"XENAI"}</span> ‚Ä¢ <span>${fmtTime(Date.now())}</span>`;
  meta.appendChild(actions);
  chat.appendChild(meta);
  smartScroll();
}
let typingRow=null;
function showTyping(){
  typingRow = document.createElement("div");
  typingRow.className = "msg bot";
  typingRow.innerHTML = `<div class="b">ü§ñ</div><div class="bubble"><span class="spin"></span> Typing‚Ä¶</div>`;
  chat.appendChild(typingRow);
  smartScroll();
}
function updateTyping(html){ if(typingRow){ typingRow.querySelector(".bubble").innerHTML = html; smartScroll(); } }
function hideTyping(){ if(typingRow){ typingRow.remove(); typingRow=null; } }

/* Smart scroll & jump */
function nearBottom(){
  const delta = chatWrap.scrollHeight - chatWrap.scrollTop - chatWrap.clientHeight;
  return delta < 140;
}
function smartScroll(){ if(nearBottom()){ chatWrap.scrollTop = chatWrap.scrollHeight; jump.style.display="none"; } else { jump.style.display="block"; } }
chatWrap.addEventListener("scroll", ()=>{ if(nearBottom()) jump.style.display="none"; });
jumpBtn.onclick = ()=> chatWrap.scrollTop = chatWrap.scrollHeight;

/* Autogrow textarea (big like major assistants) */
function autoGrow(){
  input.style.height = "auto";
  const max = Math.round(window.innerHeight * 0.42);
  input.style.height = Math.min(input.scrollHeight, max) + "px";
}
input.addEventListener("input", autoGrow);
window.addEventListener("resize", autoGrow);
setTimeout(autoGrow, 120);

/* Speech dictation (browser) */
let recog=null, recOn=false;
function initSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ micBtn.disabled=true; micBtn.title="Not supported"; return; }
  recog = new SR(); recog.lang="en-US"; recog.interimResults=true; recog.continuous=true;
  recog.onresult = e=>{
    let t=""; for(const r of e.results){ t+=r[0].transcript }
    input.value = t.trim(); autoGrow();
  };
  recog.onend = ()=>{ if(recOn) recog.start(); }
}
function toggleRec(){ if(!recog) return; recOn=!recOn; if(recOn){ recog.start(); micBtn.textContent="üõë"; } else { recog.stop(); micBtn.textContent="üéôÔ∏è"; } }
micBtn.onclick = toggleRec;

/* ================== OpenAI Streaming ================== */
async function askXENAI(modelKey, msgs){
  const apiModel = MODEL_MAP[modelKey] || MODEL_MAP["xen-5.1"];
  const headers = { "Authorization":"Bearer "+OPENAI_API_KEY, "Content-Type":"application/json" };
  const body = { model: apiModel, messages: [{role:"system", content:SYSTEM_DEFAULT}, ...msgs], temperature:0.7, stream:true };

  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method:"POST", headers, body: JSON.stringify(body)
  });
  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error("HTTP "+res.status+" ‚Äî "+txt.slice(0,300));
  }
  return res.body.getReader();
}

/* ================== Firestore Paths & Ops ================== */
function convsCol(){ return collection(db, "users", uid, "conversations"); }
function msgsCol(convId){ return collection(db, "users", uid, "conversations", convId, "messages"); }

async function ensureAtLeastOneConv(){
  // If none exists, create one
  const ref = await addDoc(convsCol(), { title:"New chat", createdAt: serverTimestamp(), updatedAt: serverTimestamp(), lastMsg:"", archived:false });
  activeConvId = ref.id; localStorage.setItem(LS_ACTIVE, activeConvId);
  startMsgsListener();
}
async function createConversation(){
  const ref = await addDoc(convsCol(), { title:"New chat", createdAt: serverTimestamp(), updatedAt: serverTimestamp(), lastMsg:"", archived:false });
  setActiveConv(ref.id);
}
function setActiveConv(id){
  activeConvId = id; localStorage.setItem(LS_ACTIVE, id);
  startMsgsListener();
}
async function renameConv(id, title){
  await updateDoc(doc(db, "users", uid, "conversations", id), { title, updatedAt: serverTimestamp() });
}
async function archiveConv(id){
  await updateDoc(doc(db, "users", uid, "conversations", id), { archived:true, updatedAt: serverTimestamp() });
  if(id===activeConvId){ activeConvId=null; chat.innerHTML=""; messages=[]; }
}

/* Conversation list listener */
function startConvsListener(){
  if(unsubConvs) unsubConvs();
  // Show non-archived, latest first
  const qy = query(convsCol(), where("archived","==",false), orderBy("updatedAt","desc"), limit(200));
  unsubConvs = onSnapshot(qy, snap=>{
    const items = []; snap.forEach(d=> items.push({ id:d.id, ...d.data() }) );
    renderConvs(items);
    const saved = localStorage.getItem(LS_ACTIVE);
    if(!activeConvId || !items.find(x=>x.id===saved)){
      if(items.length) setActiveConv(items[0].id);
      else { /* create on first send */ }
    }
  });
}
function renderConvs(items){
  const q = (searchEl.value||"").toLowerCase();
  convsEl.innerHTML = "";
  for(const it of items){
    if(q && !( (it.title||"").toLowerCase().includes(q) || (it.lastMsg||"").toLowerCase().includes(q) )) continue;
    const el = document.createElement("div");
    el.className = "conv"+(it.id===activeConvId?" active":"");
    el.innerHTML = `
      <div class="row">
        <span class="pill">${it.title?esc(it.title):"Untitled"}</span>
        <div class="actions">
          <button class="mini rename">Rename</button>
          <button class="mini del">Archive</button>
        </div>
        <span class="time">${it.updatedAt?.toDate? it.updatedAt.toDate().toLocaleDateString() : ""}</span>
      </div>
      <div class="preview">${esc(trunc(it.lastMsg||"", 80))}</div>
    `;
    el.addEventListener("click", (e)=>{
      if(e.target.classList.contains("rename") || e.target.classList.contains("del")) return;
      setActiveConv(it.id);
    });
    el.querySelector(".rename").onclick = async (e)=>{ e.stopPropagation(); const nv = prompt("Rename chat:", it.title||""); if(nv && nv.trim()) await renameConv(it.id, nv.trim()); };
    el.querySelector(".del").onclick = async (e)=>{ e.stopPropagation(); if(confirm("Archive this conversation?")) await archiveConv(it.id); };
    convsEl.appendChild(el);
  }
}
searchEl.addEventListener("input", ()=> startConvsListener());

/* Messages listener for active conversation */
function startMsgsListener(){
  if(!uid || !activeConvId) return;
  if(unsubMsgs) unsubMsgs();
  const qy = query(msgsCol(activeConvId), orderBy("ts","asc"), limit(500));
  chat.innerHTML=""; messages=[];
  unsubMsgs = onSnapshot(qy, snap=>{
    chat.innerHTML = ""; messages=[];
    if(snap.empty){ addMsg("assistant","Hello, I'm <strong>XENAI</strong>. Ask anything. Your conversations are saved on the left."); return; }
    snap.forEach(d=>{
      const m = d.data();
      messages.push({ role:m.role, content:m.content, ts: m.ts?.toMillis?.() || Date.now() });
    });
    for(const m of messages){ addMsg(m.role==="user"?"user":"assistant", m.content); }
  });
}

/* Append message */
async function appendMessage(role, content){
  if(!uid || !activeConvId) return;
  await addDoc(msgsCol(activeConvId), { role, content, ts: serverTimestamp() });
  await updateDoc(doc(db,"users",uid,"conversations",activeConvId), { updatedAt: serverTimestamp(), lastMsg: content.slice(0,140) });
}

/* ================== Auth ================== */
const provider = new GoogleAuthProvider();
onAuthStateChanged(auth, async (user)=>{
  if(user){
    uid = user.uid;
    // header
    avatar.style.display = user.photoURL ? "inline-block" : "none";
    if(user.photoURL){ avatar.src = user.photoURL; avatar.alt = user.displayName||"User"; }
    signinBtn.style.display="none"; signoutBtn.style.display="inline-block";
    // sidebar
    sideAvatar.style.display = user.photoURL ? "inline-block" : "none";
    if(user.photoURL){ sideAvatar.src=user.photoURL; sideAvatar.alt=user.displayName||"User"; }
    displayName.textContent = user.displayName || "Anonymous";
    displayEmail.textContent = user.email || "Guest session";
    authModal.classList.remove("show");
    startConvsListener();
  }else{
    uid = null; activeConvId=null; if(unsubMsgs) unsubMsgs(); if(unsubConvs) unsubConvs();
    chat.innerHTML=""; messages=[];
    avatar.style.display="none"; sideAvatar.style.display="none";
    signinBtn.style.display="inline-block"; signoutBtn.style.display="none";
    displayName.textContent="Guest"; displayEmail.textContent="Not signed in";
    convsEl.innerHTML="";
    authModal.classList.add("show");
    addMsg("assistant","Welcome to <strong>XENAI</strong>. Sign in with Google or continue as guest to keep your chat history.");
  }
});
signinBtn.onclick = ()=> authModal.classList.add("show");
googleBtn.onclick = async ()=>{ await signInWithPopup(auth, provider); };
anonBtn.onclick = async ()=>{ await signInAnonymously(auth); };
sideGoogleBtn.onclick = async ()=>{ await signInWithPopup(auth, provider); };
sideAnonBtn.onclick = async ()=>{ await signInAnonymously(auth); };
signoutBtn.onclick = ()=> signOut(auth);

/* ================== Send flow ================== */
async function handleSend(){
  const text = input.value.trim(); if(!text) return;
  input.value=""; autoGrow();

  if(!uid){ alert("Please sign in or continue as guest to chat."); return; }
  if(!activeConvId){ await ensureAtLeastOneConv(); }

  // local echo + persist
  addMsg("user", text);
  appendMessage("user", text).catch(()=>{});

  // short history for prompt
  const hist = [...messages, { role:"user", content:text }].slice(-24).map(m=>({ role: m.role==="assistant"?"assistant":"user", content: m.content }));

  // stream
  showTyping();
  try{
    const reader = await askXENAI(modelSel.value, hist);
    const decoder = new TextDecoder("utf-8");
    let buffer = "", done=false, acc="";
    while(!done){
      const {value, done:dn} = await reader.read(); done=dn;
      if(value){
        buffer += decoder.decode(value, {stream:true});
        const chunks = buffer.split("\n\n");
        buffer = chunks.pop() || "";
        for(const ch of chunks){
          const line = ch.trim();
          if(!line.startsWith("data:")) continue;
          const jsonStr = line.slice(5).trim();
          if(jsonStr === "[DONE]") continue;
          try{
            const evt = JSON.parse(jsonStr);
            const delta = evt?.choices?.[0]?.delta?.content || "";
            if(delta){ acc += delta; updateTyping(mdLite(acc)); }
          }catch{}
        }
      }
    }
    hideTyping();
    if(!acc.trim()) acc="(no content)";
    addMsg("assistant", acc);
    appendMessage("assistant", acc).catch(()=>{});
    // title on first reply
    const convRef = doc(db, "users", uid, "conversations", activeConvId);
    const snap = await getDoc(convRef);
    const title = snap.data()?.title || "";
    if(!title || title==="New chat"){
      const first = trunc(text.replace(/\n/g," "), 40);
      await updateDoc(convRef, { title: first || "Chat", updatedAt: serverTimestamp() });
    }
  }catch(err){
    hideTyping();
    addMsg("assistant", "‚ö†Ô∏è Error<br><code>"+esc(err.message||String(err))+"</code>");
  }
}
sendBtn.onclick = handleSend;
input.addEventListener("keydown", e=>{
  if(e.key==="Enter" && (e.metaKey||e.ctrlKey)){ e.preventDefault(); handleSend(); }
  else if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); handleSend(); }
});

/* New conversation */
newBtn.onclick = ()=> createConversation();
sideNewBtn.onclick = ()=> createConversation();

/* init */
initSpeech();
authModal.classList.add("show");
addMsg("assistant","Hello! I‚Äôm <strong>XENAI</strong>. Sign in with Google or continue as guest to save your chat history. Choose a XEN model above and start typing.");
</script>
</body>
</html>
